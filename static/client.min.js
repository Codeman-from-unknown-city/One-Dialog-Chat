'use strict';const APP=document.getElementById("app");function debounse(a,b){let c=!1;return function(...d){c||(c=!0,setTimeout(()=>c=!1,b),a(...d))}}function createNode(a,b,c,...d){const e=document.createElement(a);b&&(e.className=b),c&&(e.innerHTML=c);for(let f=0;f<d.length;f+=2){const a=d[f],b=d[f+1];e.addEventListener(a,b)}return e}const multiAppend=(a,...b)=>b.forEach(b=>a.append(b));(function(){const a=createNode("div","login-wrap"),b=createNode("h1","app-title","One-Dialog-Chat"),c=createNode("form","login"),d=createNode("h2","login-title","\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0438\u043C\u044F:"),e=createNode("input","login-input"),f=createNode("button","login-button","ok","click",chat);multiAppend(c,d,e,f),multiAppend(a,b,c),APP.append(a)})();function chat(a,b){function c(a){const b=debounse(b=>{m.send(JSON.stringify({type:"sendInvite",id:a.id,from:h})),b.target.innerHTML="\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E!",setTimeout(()=>b.target.innerHTML="\u041F\u0440\u0438\u0433\u043B\u0430\u0441\u0438\u0442\u044C \u0432 \u0447\u0430\u0442",3e4)},3e4),c=createNode("li","user"),d=createNode("span","user-name",a.name),e=createNode("button","invite-btn","\u041F\u0440\u0438\u0433\u043B\u0430\u0441\u0438\u0442\u044C \u0432 \u0447\u0430\u0442","click",b);multiAppend(c,d,e),l.append(c)}function d(a){if(l.innerHTML="",a.length){l.insertAdjacentHTML("afterbegin","<h1>\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u043E\u043D\u043B\u0430\u0439\u043D:</h1>");const b=createNode("input","search",null,"input",e);b.setAttribute("placeholder","\u041D\u0430\u043F\u0438\u0448\u0438\u0442\u0435 \u0438\u043C\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F, \u043A\u043E\u0442\u043E\u0440\u043E\u0433\u043E \u0438\u0449\u0435\u0442\u0435..."),l.append(b),a.forEach(c)}else l.insertAdjacentHTML("afterbegin","<h1>\u041D\u0435\u0442 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043E\u043D\u043B\u0430\u0439\u043D</h1>")}function e(a){if(""===a.target.value.trim())return void d(g);const b=g.filter(b=>-1!==b.name.indexOf(a.target.value));b&&(document.querySelectorAll(".user").forEach(a=>a.remove()),b.forEach(c))}function f(a,b,c){const d=createNode("div","notification");d.insertAdjacentHTML("afterbegin","<h3>\u041D\u043E\u0432\u043E\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435!</h3>");const e=createNode("p","info",a),f=()=>d.remove();if(b){const a=createNode("div","options"),b=createNode("button","ok-button","\u0421\u043E\u0433\u043B\u0430\u0441\u0438\u0442\u044C\u0441\u044F","click",()=>m.send(JSON.stringify({type:"responseToInvitation",response:"ok",toId:c,receiverName:h})),"click",f),g=createNode("button","no-button","\u041E\u0442\u043A\u0430\u0437\u0430\u0442\u044C\u0441\u044F","click",()=>m.send(JSON.stringify({type:"responseToInvitation",response:"no",toId:c,receiverName:h})),"click",f);multiAppend(a,b,g),multiAppend(d,e,a),i.append(d)}else{const a=createNode("span","remove-button","&#9746;","click",f);multiAppend(d,a,e),k.append(d)}}a.preventDefault();let g;const h=b?b:document.querySelector(".login-input").value;APP.innerHTML="";const i=createNode("div","invites");i.insertAdjacentHTML("afterbegin","<h1>\u041F\u0440\u0438\u0433\u043B\u0430\u0448\u0435\u043D\u0438\u044F:</h1>");const j=createNode("div","list-wrap"),k=createNode("div","anwsers");k.insertAdjacentHTML("afterbegin","<h1>\u041E\u0442\u0432\u0435\u0442\u044B:</h1>");const l=createNode("ul","users-list");j.append(l),multiAppend(APP,i,j,k);const m=new WebSocket("wss://one-dialoag-chat.herokuapp.com/");m.onopen=()=>m.send(JSON.stringify({type:"userName",name:h})),m.onmessage=a=>{const b=JSON.parse(a.data);switch(b.type){case"usersList":g=b.names,d(g);break;case"invite":if(b.beginChat){dialogInterface(m,b.name,h);break}f(`Пользователь ${b.fromName} приглашает вас в чат.`,!0,b.fromId);break;case"responseToInvitation":"ok"===b.response?(dialogInterface(m,b.fromName,h),m.send(JSON.stringify({type:"begin",name:h,id:b.id}))):"no"===b.response?f(`Пользователь ${b.fromName} отклонил ваше приглашение в чат.`):f(`Пользователь ${b.fromName} уже находится в переписке с другим человеком.`);}}}function dialogInterface(a,b,c){APP.innerHTML="";const d=b,e=createNode("div","dialog-wrap"),f=createNode("div","back",null,"click",b=>(a.close(),chat(b,c)));f.append(createNode("span",null,"&larr; \u0412\u0435\u0440\u043D\u0443\u0442\u044C\u0441\u044F \u043D\u0430\u0437\u0430\u0434"));const g=createNode("div","messages-wrap"),h=createNode("div","messages");g.append(h);const i=createNode("span","name-interlocutor",d),j=createNode("div","form-wrap"),k=createNode("form","send-form"),l=createNode("input","send-input"),m=createNode("i","fas fa-paper-plane",null,"click",b=>{b.preventDefault(),""!==l.value&&(a.send(JSON.stringify({type:"message",message:l.value})),h.append(createNode("span","message",`Вы: ${l.value}`)),l.value="")});multiAppend(j,k,l,m),multiAppend(e,i,g,j),multiAppend(APP,f,e),a.onmessage=b=>{const e=JSON.parse(b.data);"message"===e.type&&h.append(createNode("span","message",`${d}: ${e.message}`)),"out"===e.type&&(h.innerHTML="",h.append(createNode("span","out",`Ваш собеседник ${d} вышел из диалога.`)),l.disabled=!0),"invite"===e.type&&a.send(JSON.stringify({type:"responseToInvitation",response:"inChat",toId:e.fromId,receiverName:c})),"responseToInvitation"===e.type&&a.send(JSON.stringify({type:"responseToInvitation",response:"inChat",toId:e.id,receiverName:c}))}}
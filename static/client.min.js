'use strict';const APP=document.getElementById("app");function debounse(a,b){let c=!1;return function(...d){c||(c=!0,setTimeout(()=>c=!1,b),a(...d))}}function createNode(a,b,c,...d){const e=document.createElement(a);b&&(e.className=b),c&&(e.innerHTML=c);for(let f=0;f<d.length;f+=2){const a=d[f],b=d[f+1];e.addEventListener(a,b)}return e}const multiAppend=(a,...b)=>b.forEach(b=>a.append(b));(function(){const a=createNode("div","login-wrap"),b=createNode("h1","app-title","One-Dialog-Chat"),c=createNode("form","login"),d=createNode("h2","login-title","\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0438\u043C\u044F:"),e=createNode("input","login-input"),f=createNode("button","login-button","ok","click",chat);multiAppend(c,d,e,f),multiAppend(a,b,c),APP.append(a)})();function chat(a,b){function c(a,b){if(b===h)return;const c=debounse(a=>{r.send(JSON.stringify({type:"invite",fromId:h,toId:b,fromName:j})),a.target.innerHTML="\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E!",setTimeout(()=>a.target.innerHTML="\u041F\u0440\u0438\u0433\u043B\u0430\u0441\u0438\u0442\u044C \u0432 \u0447\u0430\u0442",3e4)},3e4),d=createNode("li","user"),e=createNode("span","user-name",a),f=createNode("button","invite-btn","\u041F\u0440\u0438\u0433\u043B\u0430\u0441\u0438\u0442\u044C \u0432 \u0447\u0430\u0442","click",c);multiAppend(d,e,f),q.append(d)}function d(a){if(q.innerHTML="",1<Object.keys(a).length){for(let b in n.style.display="none",a)c(a[b],b);o.style.display="block"}else o.style.display="none",n.style.display="block"}function e(a){if(""===a.target.value.trim())return void d(g);const b=g.filter(b=>-1!==b.name.indexOf(a.target.value));b&&(document.querySelectorAll(".user").forEach(a=>a.remove()),b.forEach(c))}function f(a,b,c){const d=createNode("div","notification");d.insertAdjacentHTML("afterbegin","<h3>\u041D\u043E\u0432\u043E\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435!</h3>");const e=createNode("p","info",a),f=()=>d.remove();if(b){const a=createNode("div","options"),b=()=>r.send(JSON.stringify({typeForServer:"collocutorId",type:"responseToInvitation",response:"ok",fromId:h,toId:c,fromName:j})),g=createNode("button","ok-button","\u0421\u043E\u0433\u043B\u0430\u0441\u0438\u0442\u044C\u0441\u044F","click",b,"click",f),i=createNode("button","no-button","\u041E\u0442\u043A\u0430\u0437\u0430\u0442\u044C\u0441\u044F","click",()=>r.send(JSON.stringify({type:"responseToInvitation",response:"no",toId:c,fromName:j})),"click",f);multiAppend(a,g,i),multiAppend(d,e,a),k.append(d)}else{const a=createNode("span","remove-button","&#9746;","click",f);multiAppend(d,a,e),m.append(d)}}a.preventDefault();let g,h,i=document.querySelector(".login-input");const j=b?b:i.value;if(""===j)return alert("\u0412\u044B \u043D\u0435 \u0432\u0432\u0435\u043B\u0438 \u0441\u0432\u043E\u0439 \u043B\u043E\u0433\u0438\u043D"),void(i.value="");if(25<j.length)return alert("\u0412\u0430\u0448\u0435 \u0438\u043C\u044F \u043D\u0435 \u0434\u043E\u043B\u0436\u043D\u043E \u043F\u0440\u0435\u0432\u044B\u0448\u0430\u0442\u044C 25 \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432"),void(i.value="");APP.innerHTML="";const k=createNode("div","invites");k.insertAdjacentHTML("afterbegin","<h1>\u041F\u0440\u0438\u0433\u043B\u0430\u0448\u0435\u043D\u0438\u044F:</h1>");const l=createNode("div","list-wrap"),m=createNode("div","anwsers");m.insertAdjacentHTML("afterbegin","<h1>\u041E\u0442\u0432\u0435\u0442\u044B:</h1>");const n=createNode("h1",null,"\u041D\u0435\u0442 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043E\u043D\u043B\u0430\u0439\u043D");n.style.display="none";const o=createNode("div");o.style.display="none",o.insertAdjacentHTML("afterbegin","<h1>\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u043E\u043D\u043B\u0430\u0439\u043D:</h1>");const p=createNode("input","search",null,"input",e);p.setAttribute("placeholder","\u041D\u0430\u043F\u0438\u0448\u0438\u0442\u0435 \u0438\u043C\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F, \u043A\u043E\u0442\u043E\u0440\u043E\u0433\u043E \u0438\u0449\u0435\u0442\u0435...");const q=createNode("ul","users-list");multiAppend(o,p,q),multiAppend(l,n,o),multiAppend(APP,k,l,m);const r=new WebSocket("wss://one-dialoag-chat.herokuapp.com/");r.onopen=()=>r.send(JSON.stringify({typeForServer:"userName",name:j})),r.onmessage=a=>{const b=JSON.parse(a.data);switch(console.log(b),b.type){case"id":h=b.id;break;case"usersList":g=b.users,d(g);break;case"invite":if(b.beginChat){dialogInterface(r,b.name,j);break}f(`Пользователь ${b.fromName} приглашает вас в чат.`,!0,b.fromId);break;case"responseToInvitation":"ok"===b.response?(dialogInterface(r,b.fromName,j),r.send(JSON.stringify({typeForServer:"collocutorId",type:"invite",beginChat:!0,name:j,toId:b.fromId}))):"no"===b.response?f(`Пользователь ${b.fromName} отклонил ваше приглашение в чат.`):f(`Пользователь ${b.fromName} уже находится в переписке с другим человеком.`);}}}function dialogInterface(a,b,c){APP.innerHTML="";const d=b,e=createNode("div","dialog-wrap"),f=createNode("div","back",null,"click",b=>(a.close(),chat(b,c)));f.append(createNode("span",null,"&larr; \u0412\u0435\u0440\u043D\u0443\u0442\u044C\u0441\u044F \u043D\u0430\u0437\u0430\u0434"));const g=createNode("div","messages-wrap"),h=createNode("div","messages");g.append(h);const i=createNode("span","name-interlocutor",d),j=b=>{b.preventDefault(),""!==m.value&&(a.send(JSON.stringify({typeForServer:"userMessage",type:"message",message:m.value})),h.append(createNode("span","message",`Вы: ${m.value}`)),m.value="")};document.addEventListener("keydown",a=>"Enter"===a.code?j(a):null);const k=createNode("div","form-wrap"),l=createNode("form","send-form"),m=createNode("input","send-input"),n=createNode("i","fas fa-paper-plane",null,"click",j);multiAppend(k,l,m,n),multiAppend(e,i,g,k),multiAppend(APP,f,e),a.onmessage=b=>{const e=JSON.parse(b.data);"message"===e.type&&h.append(createNode("span","message",`${d}: ${e.message}`)),"out"===e.type&&(h.innerHTML="",h.append(createNode("span","out",`Ваш собеседник ${d} вышел из диалога.`)),m.disabled=!0),"invite"===e.type&&a.send(JSON.stringify({type:"responseToInvitation",response:"inChat",toId:e.fromId,fromName:c})),"responseToInvitation"===e.type&&a.send(JSON.stringify({type:"responseToInvitation",response:"inChat",toId:e.id,fromName:c}))}}